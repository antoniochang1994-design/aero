<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Customers</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="bg-[#0A2463] text-white">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold">Customer List</h1>
      <div class="flex items-center gap-4 text-sm">
        <a href="admin-home.html" class="hover:underline">Back to Dashboard</a>
        <button id="admin-logout" class="border border-white/50 px-3 py-1 rounded">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-3 text-left">Customer ID</th>
            <th class="p-3 text-left">Name</th>
            <th class="p-3 text-left">Phone</th>
            <th class="p-3 text-left">Email</th>
            <th class="p-3 text-left">Orders</th>
            <th class="p-3 text-left">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <script>
    const STORAGE_ADMIN_AUTH = "aeroAdminAuth";
    const STORAGE_USERS = "aeroUsers";
    const STORAGE_ORDERS = "aeroOrders";

    const auth = (() => { try { return JSON.parse(sessionStorage.getItem(STORAGE_ADMIN_AUTH) || "null"); } catch (_) { return null; } })();
    if (!auth || auth.role !== "admin") window.location.href = `admin-auth.html?redirect=${encodeURIComponent("admin-customers.html")}`;

    function readUsers(){ try { return JSON.parse(localStorage.getItem(STORAGE_USERS) || "[]"); } catch (_) { return []; } }
    function readOrders(){ try { return JSON.parse(localStorage.getItem(STORAGE_ORDERS) || "[]"); } catch (_) { return []; } }

    function render() {
      const users = readUsers();
      const orders = readOrders();
      const merged = new Map();

      users.forEach((u) => {
        merged.set(u.id, { customerId: u.id, name: u.name || "-", phone: u.phone || "-", email: u.email || "-" });
      });

      orders.forEach((o) => {
        const id = o.userId || `C-${(o.phone || o.email || "unknown").replace(/\W+/g, "").slice(0, 12)}`;
        if (!merged.has(id)) {
          merged.set(id, { customerId: id, name: o.userName || "-", phone: o.phone || "-", email: o.email || "-" });
        }
      });

      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      Array.from(merged.values()).forEach((c) => {
        const orderCount = orders.filter((o) => (o.userId || "") === c.customerId || (!o.userId && (o.phone === c.phone || o.email === c.email))).length;
        const tr = document.createElement("tr");
        tr.className = "border-t";
        tr.innerHTML = `
          <td class="p-3 font-mono">${c.customerId}</td>
          <td class="p-3">${c.name}</td>
          <td class="p-3">${c.phone}</td>
          <td class="p-3">${c.email}</td>
          <td class="p-3">${orderCount}</td>
          <td class="p-3"><a class="text-[#0A2463] underline" href="admin-customer-detail.html?id=${encodeURIComponent(c.customerId)}">View Detail</a></td>`;
        tbody.appendChild(tr);
      });

      if (!tbody.children.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="p-4 text-gray-500" colspan="6">No customers</td>`;
        tbody.appendChild(tr);
      }
    }

    document.getElementById("admin-logout").addEventListener("click", () => {
      sessionStorage.removeItem(STORAGE_ADMIN_AUTH);
      window.location.href = "admin-auth.html";
    });

    render();
  </script>
</body>
</html>
